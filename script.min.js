var ngApp=angular.module("ngApp",[]);ngApp.directive("ngD3Line",[function(){return{restrict:"E",scope:{data:"="},link:function(b,f){var g=d3.time.format("%I:%M:%S"),c=parseInt(d3.select(f[0]).style("width"))-90,a=parseInt(d3.select(f[0]).style("height"))-90;d3.select(f[0]).append("svg");var d=d3.select(f[0]).select("svg").attr("width",c+90).attr("height",a+90).append("g").attr("transform","translate(45,45)"),e=d.append("text").attr("x",c/2).attr("y",-15).attr("text-anchor","middle").attr("class","graphTitle"),m=d3.time.scale().range([0,c]),h=d3.scale.linear().range([a,0]),k=d3.svg.axis().scale(m).orient("bottom").tickFormat(g),q=d3.svg.axis().scale(h).orient("left");d.append("g").attr("class","x axis").attr("transform","translate(0,"+a+")").call(k);d.append("g").attr("class","y axis").call(q).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Price $");var x=d3.svg.line(),y=d3.svg.line(),z=d3.svg.line();d.append("path").attr("class","bidLine").style("pointer-events","none");d.append("path").attr("class","askLine").style("pointer-events","none");d.append("path").attr("class","tradeLine").style("pointer-events","none");var A=d3.selectAll(".bidLine"),B=d3.selectAll(".askLine"),C=d3.selectAll(".tradeLine"),p=d3.select("body").append("div").attr("class","legend"),r=d.append("circle").attr("display","none").attr("r",4.5).attr("class","bidMarker"),s=d.append("circle").attr("display","none").attr("r",4.5).attr("class","askMarker"),t=d.append("circle").attr("display","none").attr("r",4.5).attr("class","tradeMarker"),u=d.append("line").attr("display","none").attr("class","yLine").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",a),v=d.append("line").attr("display","none").attr("class","xLine").attr("x1",0).attr("y1",0).attr("x2",c).attr("y2",0),D=d3.bisector(function(b){return b.time}).right,E=d.append("rect").attr("class","overlay").attr("width",c).attr("height",a).on("mouseover",function(){var a=b.data;if(!a||2>a.length)return!1;r.style("display","block");s.style("display","block");t.style("display","block");u.style("display","block");v.style("display","block");p.style("display","block")}).on("mouseout",function(){r.style("display","none");s.style("display","none");t.style("display","none");u.style("display","none");v.style("display","none");p.style("display","none")}).on("mousemove",function(){var a=d3.mouse(this),d=b.data;if(!d||2>d.length)return!1;r.attr("cx",a[0]);s.attr("cx",a[0]);t.attr("cx",a[0]);p.style("top",a[1]+45+10+"px").style("left",a[0]+45+10+"px").style("right","auto");var c=parseInt(d3.select(f[0]).style("width"));a[0]>c/2&&p.style("right",c-a[0]-45+10+"px").style("left","auto");u.attr("x1",a[0]).attr("x2",a[0]);v.attr("y1",a[1]).attr("y2",a[1]);var c=m.invert(a[0]),e=D(d,c),n=d[e-1],l=d[e];if(!n||!l)return!1;var k=d3.interpolateNumber(n.bidPrice,l.bidPrice),e=d3.interpolateNumber(n.askPrice,l.askPrice),d=d3.interpolateNumber(n.tradePrice,l.tradePrice),l=l.time-n.time,k=k((c-n.time)/l),e=e((c-n.time)/l),c=d((c-n.time)/l);r.attr("cy",h(k));s.attr("cy",h(e));t.attr("cy",h(c));p.html("Time: "+g(m.invert(a[0]))+" <span class='bid'>Bid: "+k.toFixed(2)+"</span> <span class='ask'>Ask: "+e.toFixed(2)+"</span> <span class='trade'>Trade: "+c.toFixed(2)+"</span>")});b.resize=function(){var w=b.data;if(!w)return!1;c=parseInt(d3.select(f[0]).style("width"))-90;a=parseInt(d3.select(f[0]).style("height"))-90;m.range([0,c]);h.range([a,0]);q.ticks(Math.max(a/20,2));k.ticks(Math.max(c/100,2));d.attr("width",c+90).attr("height",a+90);d.select(".x.axis").attr("transform","translate(0,"+a+")").call(k);d.select(".y.axis").call(q);d.selectAll(".bidLine").datum(w).attr("d",x);d.selectAll(".askLine").datum(w).attr("d",y);d.selectAll(".tradeLine").datum(w).attr("d",z);E.attr("width",c).attr("height",a);u.attr("y2",a);v.attr("x2",c);e.attr("x",c/2).attr("y",-15)};b.render=function(c){if(!c)return!1;m.domain(d3.extent(c,function(a){return a.time}));h.domain([0,11]);x.x(function(a){return m(a.time)}).y(function(a){return h(a.bidPrice)});y.x(function(a){return m(a.time)}).y(function(a){return h(a.askPrice)});z.x(function(a){return m(a.time)}).y(function(a){return h(a.tradePrice)});d.selectAll("g.axis").remove();d.append("g").attr("class","x axis").attr("transform","translate(0,"+a+")").call(k);d.append("g").attr("class","y axis").call(q).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Price $");A.datum(c).attr("d",x);B.datum(c).attr("d",y);C.datum(c).attr("d",z);b.$parent.graphCurrency&&e.text("Price vs Time ("+b.$parent.graphCurrency+")")};d3.select(window).on("resize",b.resize);b.$watch("data",function(){if(!b.data)return!1;b.data=b.data.slice();b.data.sort(function(a,b){return a.time-b.time});b.render(b.data)},!0)}}}]);ngApp.controller("dataController",["$scope","$interval","dataFactory",function(b,f,g){function c(a){var d=a.time,c={},c={};"QUOTE"===a.identifier?(b.quoteSummary[a.currencyPair]||(b.quoteSummary[a.currencyPair]={}),c={currencyPair:a.currencyPair,type:a.type,prevAskPrice:parseFloat(b.quoteSummary[a.currencyPair].askPrice),prevAskSize:parseInt(b.quoteSummary[a.currencyPair].askSize),prevBidPrice:parseFloat(b.quoteSummary[a.currencyPair].bidPrice),prevBidSize:parseInt(b.quoteSummary[a.currencyPair].bidSize),bidPrice:parseFloat(a.bidPrice),bidSize:parseInt(a.bidSize),askPrice:parseFloat(a.askPrice),askSize:parseInt(a.askSize),time:d},b.quoteSummary[a.currencyPair]=c,b.quoteList=b.quoteList.slice(0,99),b.quoteList.unshift(c)):(b.tradeSummary[a.currencyPair]||(b.tradeSummary[a.currencyPair]={}),c={currencyPair:a.currencyPair,prevTradePrice:b.tradeSummary[a.currencyPair].tradePrice,tradePrice:a.tradePrice,side:a.side,time:d},b.tradeSummary[a.currencyPair]=c,b.tradeList=b.tradeList.slice(0,99),b.tradeList.unshift(c));b.historicGraphData[a.currencyPair]||(b.historicGraphData[a.currencyPair]=[]);d=b.historicGraphData[a.currencyPair][0];graphObj={currencyPair:a.currencyPair,bidPrice:"QUOTE"===a.identifier&&"BID"===a.type?parseFloat(a.bidPrice):d?d.bidPrice:0,askPrice:"QUOTE"===a.identifier&&"ASK"===a.type?parseFloat(a.askPrice):d?d.askPrice:0,tradePrice:"TRADE"===a.identifier?parseFloat(a.tradePrice):d?d.tradePrice:0,time:new Date(a.time)};b.historicGraphData[a.currencyPair]=b.historicGraphData[a.currencyPair].slice(0,99);b.historicGraphData[a.currencyPair].unshift(graphObj);b.graphCurrency||(b.graphCurrency=a.currencyPair);b.graphCurrency==a.currencyPair&&b.graphData.unshift(graphObj)}b.quoteSummary={};b.quoteList=[];b.tradeSummary={};b.tradeList=[];b.graphData=[];b.graphCurrency=null;b.historicGraphData=[];f(function(){c(g.jsonGenerate())},1E3);b.graph=function(a){b.graphCurrency=a;b.graphData=b.historicGraphData[a]};b.trade=function(a,d,e){c({time:Date.now(),currencyPair:b.quoteSummary[e].currencyPair,identifier:"TRADE",tradePrice:"SELL"===a?b.quoteSummary[e].bidPrice:b.quoteSummary[e].askPrice,side:a})}}]);ngApp.factory("dataFactory",[function(){return{jsonGenerate:function(){var b="USDEUR EURUSD USDGBP GBPUSD GBPEUR EURGBP".split(" "),f=["QUOTE","TRADE"],g=["BID","ASK"],c=["BUY","SELL"],g=g[Math.floor(Math.random()*g.length)],c=c[Math.floor(Math.random()*c.length)];return{time:Date.now(),currencyPair:b[Math.floor(Math.random()*b.length)],type:g,identifier:f[Math.floor(Math.random()*f.length)],askPrice:(11*Math.random()+0).toFixed(2),askSize:Math.floor(1E3*Math.random())+1,bidPrice:(11*Math.random()+0).toFixed(2),bidSize:Math.floor(1E3*Math.random())+1,tradePrice:(11*Math.random()+0).toFixed(2),side:c}}}}]);